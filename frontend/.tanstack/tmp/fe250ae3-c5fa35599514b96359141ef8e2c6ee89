import { createFileRoute } from '@tanstack/react-router'
import { ChatPanelWS } from '@/components/chat/chat-panel-ws'
import { ResizableHandle } from '@/components/chat/resizable-handle'
import { Sidebar } from '@/components/chat/sidebar'
import { WorkspacePanel } from '@/components/chat/workspace-panel'
import { WelcomeDialog } from '@/components/chat/welcome-dialog'
import { createFileRoute } from '@tantml:router'
import { useState } from 'react'
import { useMessages } from '@/queries/messages'

export const Route = createFileRoute('/workspace/$workspaceId')({
  component: WorkspacePage,
})

function WorkspacePage() {
  const { workspaceId } = Route.useParams()
  const [sidebarCollapsed, setSidebarCollapsed] = useState(true)
  const [chatWidth, setChatWidth] = useState(40) // percentage
  const [chatCollapsed, setChatCollapsed] = useState(false)
  const [sidebarHovered, setSidebarHovered] = useState(false)
  const [welcomeOpen, setWelcomeOpen] = useState(false)

  // Fetch messages to check if project is new
  const { data: messagesData, isLoading } = useMessages({
    project_id: workspaceId,
    skip: 0,
    limit: 1,
  })

  // Show welcome dialog if no messages and not loading
  const hasMessages = messagesData && messagesData.count > 0
  const showWelcome = !isLoading && !hasMessages && !welcomeOpen

  return (
    <>
      <WelcomeDialog 
        open={showWelcome} 
        onOpenChange={setWelcomeOpen}
        projectId={workspaceId}
      />
      
      <div className="flex h-screen overflow-hidden bg-white relative">
        <Sidebar
          collapsed={sidebarCollapsed}
          onToggle={() => setSidebarCollapsed(!sidebarCollapsed)}
          hovered={sidebarHovered}
          onHoverChange={setSidebarHovered}
        />

        <div className="flex flex-1 overflow-hidden">
          {!chatCollapsed && (
            <>
              <div className="flex flex-col overflow-hidden" style={{ width: "${chatWidth}%" }}>
                <ChatPanelWS
                  sidebarCollapsed={sidebarCollapsed}
                  onToggleSidebar={() => setSidebarCollapsed(false)}
                  onCollapse={() => setChatCollapsed(true)}
                  onSidebarHover={setSidebarHovered}
                  projectId={workspaceId}
                />
              </div>

              <ResizableHandle
                onResize={(delta) => {
                  const newWidth = chatWidth + (delta / window.innerWidth) * 100
                  setChatWidth(Math.max(20, Math.min(80, newWidth)))
                }}
              />
            </>
          )}

          <div className="flex-1 overflow-hidden">
            <WorkspacePanel chatCollapsed={chatCollapsed} onExpandChat={() => setChatCollapsed(false)} />
          </div>
        </div>
      </div>
    </>
  )
}
