"""update db2

Revision ID: ece22f8ec0f3
Revises: 8071f4fa371a
Create Date: 2025-12-14 15:22:46.156880

"""
from alembic import op
import sqlalchemy as sa
import sqlmodel
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = 'ece22f8ec0f3'
down_revision = '8071f4fa371a'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_workflow_policies_project_id'), table_name='workflow_policies')
    op.drop_table('workflow_policies')
    op.add_column('agent_executions', sa.Column('agent_id', sa.UUID(), nullable=True))
    op.add_column('agent_executions', sa.Column('pool_id', sa.UUID(), nullable=True))
    op.create_index(op.f('ix_agent_executions_agent_id'), 'agent_executions', ['agent_id'], unique=False)
    op.create_index(op.f('ix_agent_executions_pool_id'), 'agent_executions', ['pool_id'], unique=False)
    op.create_foreign_key('fk_agent_executions_agent_id', 'agent_executions', 'agents', ['agent_id'], ['id'], ondelete='SET NULL', use_alter=True)
    op.create_foreign_key('fk_agent_executions_pool_id', 'agent_executions', 'agent_pools', ['pool_id'], ['id'], ondelete='SET NULL', use_alter=True)
    
    # Add priority column with default value for existing rows
    op.add_column('agent_pools', sa.Column('priority', sa.Integer(), nullable=True))
    op.execute("UPDATE agent_pools SET priority = 0 WHERE priority IS NULL")
    op.alter_column('agent_pools', 'priority', nullable=False)
    op.create_index(op.f('ix_agent_pools_priority'), 'agent_pools', ['priority'], unique=False)
    
    # Add agent metrics columns with default values for existing rows
    op.add_column('agents', sa.Column('tokens_used_total', sa.Integer(), nullable=True))
    op.add_column('agents', sa.Column('tokens_used_today', sa.Integer(), nullable=True))
    op.add_column('agents', sa.Column('llm_calls_total', sa.Integer(), nullable=True))
    op.execute("UPDATE agents SET tokens_used_total = 0 WHERE tokens_used_total IS NULL")
    op.execute("UPDATE agents SET tokens_used_today = 0 WHERE tokens_used_today IS NULL")
    op.execute("UPDATE agents SET llm_calls_total = 0 WHERE llm_calls_total IS NULL")
    op.alter_column('agents', 'tokens_used_total', nullable=False)
    op.alter_column('agents', 'tokens_used_today', nullable=False)
    op.alter_column('agents', 'llm_calls_total', nullable=False)
    
    op.create_index('ix_messages_agent_created', 'messages', ['agent_id', 'created_at'], unique=False)
    op.create_index('ix_messages_project_created', 'messages', ['project_id', 'created_at'], unique=False)
    op.add_column('projects', sa.Column('dev_server_port', sa.Integer(), nullable=True))
    op.add_column('projects', sa.Column('dev_server_pid', sa.Integer(), nullable=True))
    op.add_column('projects', sa.Column('db_container_id', sqlmodel.sql.sqltypes.AutoString(length=100), nullable=True))
    op.add_column('projects', sa.Column('db_port', sa.Integer(), nullable=True))
    op.add_column('stories', sa.Column('pr_state', sqlmodel.sql.sqltypes.AutoString(length=50), nullable=True))
    op.create_index(op.f('ix_stories_assignee_id'), 'stories', ['assignee_id'], unique=False)
    op.create_index(op.f('ix_stories_epic_id'), 'stories', ['epic_id'], unique=False)
    op.create_index('ix_stories_project_assignee', 'stories', ['project_id', 'assignee_id'], unique=False)
    op.create_index('ix_stories_project_created', 'stories', ['project_id', 'created_at'], unique=False)
    op.create_index('ix_stories_project_status', 'stories', ['project_id', 'status'], unique=False)
    op.create_index(op.f('ix_stories_status'), 'stories', ['status'], unique=False)
    
    # Add missing values to storyagentstate enum if they don't exist
    op.execute("ALTER TYPE storyagentstate ADD VALUE IF NOT EXISTS 'PAUSED'")
    op.execute("ALTER TYPE storyagentstate ADD VALUE IF NOT EXISTS 'CANCEL_REQUESTED'")
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_stories_status'), table_name='stories')
    op.drop_index('ix_stories_project_status', table_name='stories')
    op.drop_index('ix_stories_project_created', table_name='stories')
    op.drop_index('ix_stories_project_assignee', table_name='stories')
    op.drop_index(op.f('ix_stories_epic_id'), table_name='stories')
    op.drop_index(op.f('ix_stories_assignee_id'), table_name='stories')
    op.drop_column('stories', 'pr_state')
    op.drop_column('projects', 'db_port')
    op.drop_column('projects', 'db_container_id')
    op.drop_column('projects', 'dev_server_pid')
    op.drop_column('projects', 'dev_server_port')
    op.drop_index('ix_messages_project_created', table_name='messages')
    op.drop_index('ix_messages_agent_created', table_name='messages')
    op.drop_column('agents', 'llm_calls_total')
    op.drop_column('agents', 'tokens_used_today')
    op.drop_column('agents', 'tokens_used_total')
    op.drop_index(op.f('ix_agent_pools_priority'), table_name='agent_pools')
    op.drop_column('agent_pools', 'priority')
    op.drop_constraint('fk_agent_executions_pool_id', 'agent_executions', type_='foreignkey')
    op.drop_constraint('fk_agent_executions_agent_id', 'agent_executions', type_='foreignkey')
    op.drop_index(op.f('ix_agent_executions_pool_id'), table_name='agent_executions')
    op.drop_index(op.f('ix_agent_executions_agent_id'), table_name='agent_executions')
    op.drop_column('agent_executions', 'pool_id')
    op.drop_column('agent_executions', 'agent_id')
    op.create_table('workflow_policies',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    sa.Column('updated_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    sa.Column('project_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('from_status', sa.VARCHAR(length=50), autoincrement=False, nullable=False),
    sa.Column('to_status', sa.VARCHAR(length=50), autoincrement=False, nullable=False),
    sa.Column('criteria', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('required_role', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('is_active', sa.BOOLEAN(), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], name=op.f('workflow_policies_project_id_fkey'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('workflow_policies_pkey'))
    )
    op.create_index(op.f('ix_workflow_policies_project_id'), 'workflow_policies', ['project_id'], unique=False)
    # ### end Alembic commands ###
