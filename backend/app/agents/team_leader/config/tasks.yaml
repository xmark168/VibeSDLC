# Team Leader Tasks - CrewAI Sequential Workflow
# Following 80/20 rule: 80% effort on detailed task descriptions (HOW), 20% on expected outputs (WHAT)

analyze_kanban_context:
  description: >
    Analyze the user's message in the full context of the current Kanban board state.
    
    INPUT DATA YOU WILL RECEIVE:
    - user_message: The user's raw message text
    - backlog_count: Number of stories in Backlog column
    - todo_count: Number of stories in Todo (ready for development)
    - in_progress_current: Current stories in InProgress
    - in_progress_limit: WIP limit for InProgress
    - in_progress_wip_pct: WIP utilization percentage (0-100)
    - review_current: Current stories in Review
    - review_limit: WIP limit for Review
    - review_wip_pct: WIP utilization percentage for Review
    - done_count: Completed stories count
    - bottlenecks: List of aging stories (>48 hours in column)
    - cycle_time: Average cycle time in days
    - flow_metrics: Throughput and other metrics
    - epics_progress: Epic completion percentages
    - board_snapshot: Full board organized by column
    
    YOUR ANALYSIS PROCESS:
    
    1. **Parse User Intent**
       - What is the user trying to accomplish?
       - Is there a specific story ID mentioned (e.g., "story #123")?
       - What action words are used? (implement, test, analyze, status, etc.)
       - Is this urgent or routine?
    
    2. **Identify Affected Columns**
       - Which Kanban column(s) does this request involve?
       - For work pull requests: What's the source column? Target column?
       - For status requests: Which columns should be included in response?
    
    3. **Check Flow Constraints**
       - Are there WIP limits that apply to this request?
       - Are any relevant columns at or near capacity?
       - Are there bottlenecks blocking this type of work?
       - What's the current cycle time trend?
    
    4. **Assess Story Context**
       - If a specific story is mentioned, which column is it in?
       - Is the story in the right state for the requested action?
       - Are there dependencies or blockers?
    
    5. **Summarize Relevant Context**
       - Highlight the board metrics most relevant to this request
       - Flag any constraints that will affect routing decisions
       - Note opportunities (e.g., available capacity)
    
    Be thorough but focused - your analysis feeds directly into intent classification
    and routing decisions. Connect the user's request to the board reality.
    
  expected_output: >
    A structured markdown analysis with these sections:
    
    ## User Intent
    [1-2 sentences: What the user wants to accomplish]
    
    ## Affected Columns
    [List of columns involved, e.g., "Todo → InProgress"]
    
    ## Story References
    [Any specific story IDs mentioned, or "None"]
    
    ## Flow Constraints
    [Relevant WIP limits, bottlenecks, or capacity issues]
    
    ## Key Board Metrics
    [The 2-3 most relevant metrics for this request]
    
    ## Analysis Summary
    [2-3 sentences connecting user intent to board state]
    
  agent: kanban_context_analyzer

classify_intent:
  description: >
    Classify the user's intent into a specific category based on the Kanban context analysis.
    
    You will receive the user's original message and the detailed context analysis from the
    previous task. Your job is to categorize what type of request this is so that downstream
    routing can handle it appropriately.
    
    INTENT CATEGORIES:
    
    1. **STATUS_CHECK**
       - User asking about progress, board state, or project status
       - Examples: "what's our progress?", "how are we doing?", "project status?"
       - Indicators: question words (what, how, where), status-related terms
    
    2. **PULL_WORK**
       - User wants to start/continue work on a story
       - Examples: "implement story #123", "start developing feature X", "work on this"
       - Indicators: action verbs (implement, develop, build, code), story references
       - CRITICAL: Requires WIP capacity check before routing
    
    3. **REQUEST_ANALYSIS**
       - User needs requirements analyzed or PRD created
       - Examples: "analyze this feature", "create requirements for X", "what do we need?"
       - Indicators: analysis terms, requirements, specifications, PRD mentions
    
    4. **REQUEST_TESTING**
       - User wants QA/testing performed
       - Examples: "test story #456", "QA this feature", "check for bugs"
       - Indicators: test, QA, quality, bug-related terms
    
    5. **OPTIMIZATION_INQUIRY**
       - User asking about flow improvements or process optimization
       - Examples: "how can we improve flow?", "why is this slow?", "optimize process"
       - Indicators: improvement, optimization, efficiency, bottleneck terms
    
    6. **GREETING_OR_GENERAL**
       - Simple greetings or general questions
       - Examples: "hello", "hi there", "what can you do?"
       - Handle directly with friendly response
    
    7. **AMBIGUOUS**
       - Request is unclear or needs clarification
       - When you're not confident about intent classification
       - Better to flag as ambiguous than guess wrong
    
    CLASSIFICATION PROCESS:
    
    1. Read the user's message carefully
    2. Review the context analysis for clues
    3. Match patterns against intent categories
    4. Check for story IDs (usually indicates PULL_WORK or REQUEST_TESTING)
    5. Assess confidence level (high/medium/low)
    6. If confidence is low, classify as AMBIGUOUS
    7. Provide clear reasoning for your classification
    
  expected_output: >
    A JSON object with:
    ```json
    {
      "intent": "[INTENT_CATEGORY]",
      "confidence": "[high|medium|low]",
      "reasoning": "[1-2 sentences explaining why]",
      "requires_wip_check": [true|false],
      "suggested_column": "[column name if applicable]"
    }
    ```
    
  agent: intent_classifier
  context:
    - analyze_kanban_context

route_decision:
  description: >
    Make the routing decision based on intent classification and Kanban constraints.
    
    You will receive:
    - The user's original message
    - The Kanban context analysis
    - The intent classification
    - Current WIP status for all columns
    - Board snapshot showing story distribution
    
    YOUR ROUTING DECISION PROCESS:
    
    **Step 1: Understand the Intent**
    - Review the classified intent category
    - Check confidence level - if low confidence, route to Team Leader for clarification
    
    **Step 2: Apply Routing Rules Based on Intent**
    
    For STATUS_CHECK:
    - Action: HANDLE_DIRECTLY
    - Agent: team_leader
    - Reason: Team Leader provides status updates
    
    For REQUEST_ANALYSIS:
    - Action: DELEGATE
    - Agent: business_analyst
    - Reason: BA handles requirements analysis and PRD creation
    - Note: No WIP check needed (Backlog has no limit)
    
    For PULL_WORK:
    - Must check target column WIP capacity first
    - If story in Todo and InProgress has capacity:
      - Action: DELEGATE
      - Agent: developer
      - Reason: Include WIP status in reason
    - If story in Todo but InProgress at WIP limit:
      - Action: HANDLE_DIRECTLY
      - Agent: team_leader
      - Reason: Explain WIP constraint, suggest waiting
    
    For REQUEST_TESTING:
    - Must check Review column capacity
    - If story in Review and Tester available:
      - Action: DELEGATE
      - Agent: tester
      - Reason: Include Review status
    - If Review at capacity:
      - Action: HANDLE_DIRECTLY
      - Agent: team_leader
      - Reason: Explain constraint
    
    For OPTIMIZATION_INQUIRY:
    - Action: HANDLE_DIRECTLY
    - Agent: team_leader
    - Reason: Provide flow analysis and suggestions
    
    For GREETING_OR_GENERAL:
    - Action: HANDLE_DIRECTLY
    - Agent: team_leader
    - Reason: Provide friendly greeting and guidance
    
    For AMBIGUOUS:
    - Action: HANDLE_DIRECTLY
    - Agent: team_leader
    - Reason: Request clarification from user
    
    **Step 3: Verify WIP Capacity (if applicable)**
    
    If routing to Developer (InProgress):
    - Check in_progress_current < in_progress_limit
    - Calculate available_capacity = limit - current
    - If capacity available: Approve routing
    - If at limit: Block routing, explain constraint
    
    If routing to Tester (Review):
    - Check review_current < review_limit
    - If capacity available: Approve routing
    - If at limit: Block routing, suggest waiting
    
    **Step 4: Format Routing Decision**
    
    Your decision must be clear, actionable, and include Kanban reasoning.
    Always explain WHY you're routing this way, connecting to board state.
    
  expected_output: >
    A JSON object with routing decision:
    ```json
    {
      "action": "[HANDLE_DIRECTLY or DELEGATE]",
      "agent": "[team_leader|business_analyst|developer|tester]",
      "reason": "[Detailed explanation with Kanban context, 2-3 sentences]",
      "wip_check": {
        "required": [true|false],
        "column": "[column name if applicable]",
        "current": [number],
        "limit": [number],
        "available": [number],
        "can_pull": [true|false]
      },
      "next_steps": "[What happens next, 1 sentence]",
      "vietnamese_context": "[Key info for Vietnamese response generation]"
    }
    ```
    
    **Example Vietnamese Context Values:**
    - "Story #123 ở Todo, InProgress có 2/5 slots trống"
    - "Cột InProgress đầy (5/5), chờ story #120 chuyển sang Review"
    - "Yêu cầu phân tích requirements, route cho BA"
    - "User hỏi progress, báo cáo board status"
    - "WIP limit blocked, giải thích constraint"
    
  agent: intelligent_router
  context:
    - analyze_kanban_context
    - classify_intent

generate_response:
  description: >
    Generate a natural, helpful response to the user based on the routing decision.
    
    {language_instruction}
    
    You will receive:
    - The user's original message
    - The complete Kanban context analysis
    - The intent classification
    - The routing decision with all details
    - response_language: The language to use (Vietnamese)
    - language_instruction: Specific language requirements
    
    YOUR RESPONSE GENERATION PROCESS:
    
    **Step 1: Determine Response Type**
    
    If action is DELEGATE:
    - Explain where the request is being routed and why
    - Include relevant Kanban context (WIP status, story state, etc.)
    - Set expectations about what happens next
    - Keep tone helpful and informative
    
    If action is HANDLE_DIRECTLY:
    - Provide the appropriate direct response based on intent
    - For STATUS_CHECK: Summarize board state with key metrics
    - For GREETING: Welcome user and explain how to get help
    - For AMBIGUOUS: Ask clarifying questions
    - For WIP_BLOCKED: Explain constraint and suggest alternatives
    
    **Step 2: Craft Natural Language**
    
    Communication principles:
    - Write like a helpful colleague, not a bot
    - Use "I'm" and "I've" instead of "The system"
    - Weave in context naturally, don't dump data
    - Be specific but concise
    - Include story IDs when relevant
    - Show empathy for constraints
    
    **Step 3: Structure the Response**
    
    Good response structure:
    1. Acknowledge the request (1 sentence)
    2. Explain the routing/action (1-2 sentences with context)
    3. Set expectations or next steps (1 sentence)
    
    **Step 4: Examples of Good Responses**
    
    Example 1 - DELEGATE with capacity:
    "I've routed your request to implement story #123 to the Developer. The story is in
    Todo and we have capacity in InProgress (3/5 slots used), so they can pull it now.
    You'll get updates as development progresses."
    
    Example 2 - HANDLE_DIRECTLY due to WIP limit:
    "I'd love to route this to the Developer, but our InProgress column is currently at
    capacity (5/5 stories). Let's wait for one of the active stories to move to Review,
    then we can pull story #123. Currently, story #120 is closest to completion."
    
    Example 3 - STATUS_CHECK:
    "Here's our current status: We have 3 stories In Progress (60% of capacity), 2 in
    Review awaiting QA, and 8 completed this week. Cycle time is averaging 3.2 days,
    which is solid. The Epic 'User Authentication' is 75% complete with 3 of 4 stories
    done."
    
    Example 4 - GREETING:
    "Hi! I'm Victoria, the Team Leader for this project. I help coordinate work across
    the team and keep things flowing smoothly. You can ask me about project status,
    request work on stories, or tag specialists directly - @BusinessAnalyst for analysis,
    @Developer for implementation, @Tester for QA."
    
    **Step 5: Add Helpful Context**
    
    When appropriate, include:
    - WIP utilization percentages
    - Story counts per column
    - Cycle time trends
    - Epic progress
    - Bottleneck warnings
    - Next story recommendations
    
    But don't info-dump - only include what's relevant to this specific request.
    
  expected_output: >
    A natural Vietnamese language response to the user (4-5 sentences max).
    
    **Vietnamese Response Examples:**
    
    **Example 1 - STATUS_CHECK Intent:**
    ```
    Dự án hiện đang tiến triển tốt! Có 3 stories đang InProgress (60% capacity),
    2 stories ở Review chờ QA, và tuần này đã hoàn thành 8 stories. Cycle time 
    trung bình là 3.2 ngày, khá ổn định. Epic 'User Authentication' đã xong 75% 
    với 3/4 stories hoàn thành.
    ```
    
    **Example 2 - DELEGATE to Developer (with capacity):**
    ```
    Tôi đã chuyển yêu cầu implement story #123 cho Lập trình viên. Story này đang 
    ở Todo và InProgress còn trống 2/5 slots, nên có thể pull ngay. Bạn sẽ được 
    update khi development bắt đầu.
    ```
    
    **Example 3 - DELEGATE to Business Analyst:**
    ```
    Tôi đã chuyển yêu cầu phân tích này cho Chuyên viên Phân tích (BA). Họ sẽ 
    interview bạn để làm rõ requirements và tạo PRD chi tiết. Bạn sẽ nhận được 
    câu hỏi làm rõ trong giây lát.
    ```
    
    **Example 4 - HANDLE_DIRECTLY (WIP limit blocked):**
    ```
    Hiện tại cột InProgress đang full capacity (5/5 stories), nên chưa thể pull 
    thêm work ngay. Story #120 sắp xong và sẽ chuyển sang Review sớm. Khi có slot 
    trống, tôi sẽ báo bạn để pull story #123 nhé.
    ```
    
    **Example 5 - GREETING:**
    ```
    Xin chào! Tôi là Victoria, Trưởng nhóm của dự án này. Tôi giúp điều phối công 
    việc giữa các thành viên và theo dõi tiến độ. Bạn có thể hỏi tôi về tình trạng 
    dự án, yêu cầu làm việc trên stories, hoặc tag trực tiếp: @BusinessAnalyst cho 
    phân tích, @Developer cho code, @Tester cho QA.
    ```
    
    **Example 6 - AMBIGUOUS Request:**
    ```
    Tôi chưa hiểu rõ yêu cầu của bạn lắm. Bạn muốn:
    - Kiểm tra tiến độ dự án?
    - Bắt đầu làm việc trên một story cụ thể?
    - Phân tích requirements cho feature mới?
    - Hay điều gì khác?
    
    Vui lòng mô tả cụ thể hơn để tôi hỗ trợ tốt hơn nhé!
    ```
    
    **Response Guidelines:**
    - Use {response_language} (Vietnamese)
    - Natural, conversational tone
    - Include relevant Kanban metrics when appropriate
    - Explain routing decisions with context
    - Set clear expectations about next steps
    
  agent: response_coordinator
  context:
    - analyze_kanban_context
    - classify_intent
    - route_decision
