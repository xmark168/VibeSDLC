"""add_account_status_to_github_installation

Revision ID: 79cc072c7d18
Revises: 52a9559cb2a7
Create Date: 2025-11-05 18:13:06.364178

"""
from alembic import op
import sqlalchemy as sa
import sqlmodel.sql.sqltypes


# revision identifiers, used by Alembic.
revision = '79cc072c7d18'
down_revision = '52a9559cb2a7'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # Create enum type first
    github_installation_status_enum = sa.Enum('PENDING', 'INSTALLED', 'DELETED', name='githubinstallationstatus')
    github_installation_status_enum.create(op.get_bind(), checkfirst=True)

    # Add column with default value for existing rows
    op.add_column('github_installations', sa.Column('account_status', github_installation_status_enum, nullable=False, server_default='INSTALLED'))

    # Update existing rows: set status based on user_id
    op.execute("""
        UPDATE github_installations
        SET account_status = (CASE
            WHEN user_id IS NULL THEN 'PENDING'
            ELSE 'INSTALLED'
        END)::githubinstallationstatus
    """)

    # Remove server_default after data migration
    op.alter_column('github_installations', 'account_status', server_default=None)

    op.alter_column('github_installations', 'installation_id',
               existing_type=sa.INTEGER(),
               nullable=True)
    op.create_index(op.f('ix_github_installations_account_status'), 'github_installations', ['account_status'], unique=False)
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_github_installations_account_status'), table_name='github_installations')
    op.alter_column('github_installations', 'installation_id',
               existing_type=sa.INTEGER(),
               nullable=False)
    op.drop_column('github_installations', 'account_status')
    # ### end Alembic commands ###
